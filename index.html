<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chenda ‚Äî Kraken Live</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <header class="bar">
    <div class="brand">
      <div class="title">Chenda ‚Äî Kraken Live (no Binance)</div>
      <small id="status-text">Loading‚Ä¶</small>
    </div>
    <div class="stamp">Last updated: <span id="updated-at">‚Äî</span></div>
    <div class="controls"><button id="refresh-btn" class="ghost" type="button">üîÑ Refresh</button></div>
  </header>

  <main>
    <section class="view">
      <div class="col">
        <div class="card">
          <div class="card-h">
            <span>Kraken Symbols</span>
            <span class="pill"><strong id="kraken-count">0</strong> symbols</span>
          </div>
          <div id="kraken-list" class="list"></div>
        </div>

        <div class="card">
          <div class="card-h">
            <span>Whale Levels (Top)</span>
            <span class="pill" id="whale-meta">‚Äî</span>
          </div>
          <table id="whale-table">
            <thead><tr><th>Symbol</th><th>Side</th><th>Price</th><th>Qty</th><th>USD</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <div class="card-h">
            <span>Latest Snapshot (/signal)</span>
            <span class="pill">read-only</span>
          </div>
          <pre id="metrics-pre">‚Äî</pre>
        </div>
      </div>
    </section>
  </main>

  <footer class="foot">¬© Chenda ‚Äî Kraken-only view</footer>

  <!-- Backend base URL (Render) -->
  <script>
    window.CHENDA_SIGNAL_URL = "https://<your-render-app>.onrender.com";
  </script>

  <script>
  (function () {
  const backendBase = (typeof window !== "undefined" && (window.CHENDA_SIGNAL_URL || window.CHENDA_BACKEND)) || "";
  const POLL_MS = 10000;

  const els = {
    status: document.getElementById("status-text"),
    updatedAt: document.getElementById("updated-at"),
    refreshBtn: document.getElementById("refresh-btn"),
    krakenList: document.getElementById("kraken-list"),
    krakenCount: document.getElementById("kraken-count"),
    whaleTable: document.getElementById("whale-table").querySelector("tbody"),
    whaleMeta: document.getElementById("whale-meta"),
    metricsPre: document.getElementById("metrics-pre"),
  };

  function h(tag, attrs, ...kids) {
    const el = document.createElement(tag);
    if (attrs) for (const [k, v] of Object.entries(attrs)) {
      if (k === "class") el.className = v;
      else if (k === "text") el.textContent = v;
      else el.setAttribute(k, v);
    }
    for (const kid of kids) {
      if (kid == null) continue;
      el.appendChild(typeof kid === "string" ? document.createTextNode(kid) : kid);
    }
    return el;
  }

  function renderSymbols(data) {
    const list = els.krakenList;
    list.innerHTML = "";
    const items = Array.isArray(data) ? data : (data && data.data ? data.data : []);
    const symbols = [];
    for (const row of items) {
      if (!row || !row.symbol) continue;
      symbols.push(row.symbol);
      const chip = h("div", { class: "chip" },
        h("span", { class: "sym", text: row.symbol }),
        h("span", { text: String(row.price ?? "‚Äî") }),
        h("small", { text: row.price_venue ? `  @ ${row.price_venue}` : "" })
      );
      list.appendChild(chip);
    }
    els.krakenCount.textContent = String(symbols.length);
  }

  function formatUsd(v) {
    if (v == null || isNaN(v)) return "‚Äî";
    if (v >= 1e9) return (v/1e9).toFixed(2) + "B";
    if (v >= 1e6) return (v/1e6).toFixed(2) + "M";
    if (v >= 1e3) return (v/1e3).toFixed(2) + "K";
    return Number(v).toFixed(0);
  }

  function renderWhales(data) {
    const tbody = els.whaleTable;
    tbody.innerHTML = "";
    const items = Array.isArray(data) ? data : (data && data.data ? data.data : []);
    const rows = [];
    for (const row of items) {
      if (!row || !row.symbol || !row.whales) continue;
      const sym = row.symbol;
      for (const b of (row.whales.bids || []).slice(0, 5)) {
        rows.push([sym, "BID", b.price, b.qty, b.usd]);
      }
      for (const a of (row.whales.asks || []).slice(0, 5)) {
        rows.push([sym, "ASK", a.price, a.qty, a.usd]);
      }
    }
    rows.sort((A, B) => (B[4]||0) - (A[4]||0));
    const top = rows.slice(0, 20);
    for (const [sym, side, p, q, u] of top) {
      const tr = h("tr", null,
        h("td", { text: sym }),
        h("td", { text: side }),
        h("td", { text: String(p) }),
        h("td", { text: String(q) }),
        h("td", { text: formatUsd(u) })
      );
      tbody.appendChild(tr);
    }
    els.whaleMeta.textContent = top.length ? `${top.length} levels` : "no levels";
  }

  async function fetchSignal() {
    const urlBase = backendBase ? backendBase.replace(/\/$/, "") : "";
    const url = urlBase ? (urlBase + "/signal") : "/signal";
    try {
      const res = await fetch(url, { credentials: "omit", mode: "cors" });
      if (!res.ok) throw new Error(res.status + " " + res.statusText);
      const data = await res.json();
      const payload = data && (Array.isArray(data) ? data : data.data) || [];

      const nowStr = new Date().toLocaleString();
      els.status.textContent = "‚úÖ Live ‚Äî " + nowStr;
      els.updatedAt.textContent = nowStr;

      renderSymbols(payload);
      renderWhales(payload);
      els.metricsPre.textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      els.status.textContent = "‚ùå " + (err && err.message ? err.message : String(err));
    }
  }

  els.refreshBtn.addEventListener("click", fetchSignal);
  setInterval(fetchSignal, POLL_MS);
  fetchSignal();
})();
  </script>
</body>
</html>
